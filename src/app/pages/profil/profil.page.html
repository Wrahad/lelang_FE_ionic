<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Profil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="page">
  <ng-container *ngIf="user$ | async as user; else loading">
    <div class="container">

      <ion-card class="card header-card">
        <ion-card-content class="header-row">
          <div class="header-icon">
            <ion-icon name="person" class="person-icon"></ion-icon>
          </div>
          <div class="header-content">
            <h1 class="header-title">Profil Pembeli</h1>
            <p class="header-subtitle">Informasi lengkap data pembeli Anda</p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="card profile-card">
        <ion-card-content class="profile-row">
          <ion-avatar class="profile-avatar">
            <div class="avatar-fallback">{{ user.name[0] || 'U' }}</div>
            <ion-icon *ngIf="profileService.isVerified" class="avatar-badge" name="checkmark-circle"></ion-icon>
          </ion-avatar>
          <div class="profile-info">
            <h2 class="profile-name">{{ user.name || 'Pengguna' }}</h2>
            <p class="profile-email">{{ user.email }}</p>
            <ion-chip *ngIf="profileService.isVerified" class="chip-verified">Terverifikasi</ion-chip>
            <ion-chip *ngIf="!profileService.isVerified" class="chip-unverified">Belum Diverifikasi</ion-chip>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-card class="card personal-info-card">
        <ion-card-content>
          <h3 class="section-title">Informasi Pribadi</h3>
          <div class="info-card">
            <div class="info-icon-wrapper phone"><ion-icon name="call" class="info-icon"></ion-icon></div>
            <div class="info-content">
              <div class="info-label">Nomor Telepon</div>
              <div class="info-value">{{ user.pembeli?.telepon_pembeli || 'Belum diisi' }}</div>
            </div>
          </div>
          <div class="info-card">
            <div class="info-icon-wrapper location"><ion-icon name="location-outline" class="info-icon"></ion-icon></div>
            <div class="info-content">
              <div class="info-label">Alamat Lengkap</div>
              <div class="info-value">{{ user.pembeli?.alamat_pembeli || 'Belum diisi' }}</div>
            </div>
          </div>

          <div class="ktp-section" [ngClass]="{
              'ktp-warning': !user.pembeli?.foto_ktp && !profileService.isRejected,
              'ktp-pending': profileService.isPending,
              'ktp-approved': profileService.isVerified,
              'ktp-rejected': profileService.isRejected
            }">
            <div class="ktp-header-row">
              <ion-icon [name]="profileService.isVerified ? 'checkmark-circle' : (profileService.isPending ? 'time' : 'warning')"></ion-icon>
              <div class="ktp-content">
                <div class="ktp-title-row">
                  <span class="ktp-title">Kartu Tanda Penduduk (KTP)</span>
                  <div class="ktp-status-badge" *ngIf="user.pembeli?.status_verifikasi">
                    {{ user.pembeli?.status_verifikasi | uppercase }}
                  </div>
                </div>
                <p class="ktp-description">
                  <span *ngIf="!user.pembeli?.foto_ktp">Silakan unggah foto KTP Anda.</span>
                  <span *ngIf="profileService.isPending">Verifikasi KTP sedang dalam proses.</span>
                  <span *ngIf="profileService.isVerified">KTP Anda telah diverifikasi.</span>
                  <span *ngIf="profileService.isRejected">KTP Anda ditolak. {{ user.pembeli?.alasan_penolakan }}</span>
                </p>
              </div>
            </div>

            <div *ngIf="user.pembeli?.foto_ktp_url" class="ktp-image-section" (click)="openImagePreview(user.pembeli?.foto_ktp_url)">
              <div class="ktp-image-container">
                <img [src]="user.pembeli?.foto_ktp_url" alt="Foto KTP" class="ktp-image">
                <div class="ktp-image-overlay"><ion-icon name="eye" class="view-icon"></ion-icon></div>
              </div>
            </div>

            <div class="ktp-action">
              <ion-button *ngIf="!user.pembeli?.foto_ktp_url || profileService.isRejected" size="small" (click)="openKtpUploadDialog()">
                {{ profileService.isRejected ? 'Upload Ulang' : 'Upload KTP' }}
              </ion-button>
              <div *ngIf="profileService.isVerified" class="ktp-verified-info">
                <ion-icon name="checkmark" class="verified-icon"></ion-icon>
                <span>KTP Terverifikasi</span>
              </div>
              <div *ngIf="profileService.isPending" class="ktp-pending-info">
                <ion-icon name="time" class="pending-icon"></ion-icon>
                <span>Sedang Diverifikasi</span>
              </div>
            </div>
          </div>
          
          <div class="footer-actions">
            <ion-button fill="outline" size="small" (click)="openEditProfileModal()">
              Update Profil
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </ng-container>

  <ng-template #loading>
    <div class="container ion-text-center">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  </ng-template>

  <ion-modal [isOpen]="showImageModal" (didDismiss)="closeImagePreview()">
    <ng-template>
      <ion-content class="image-modal">
        <div class="image-modal-toolbar">
          <ion-buttons slot="start">
            <ion-button (click)="closeImagePreview()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
          <div class="image-modal-title">Pratinjau KTP</div>
        </div>
        <div class="image-modal-body">
          <img [src]="previewImageUrl" alt="KTP Preview">
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>